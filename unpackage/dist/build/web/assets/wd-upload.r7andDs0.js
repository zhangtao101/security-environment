import{Y as e,Z as s,_ as a,$ as o,d as t,r as l,k as i,o as r,a as n,b as u,e as c,x as d,E as p,n as m,g as f,P as v,a0 as y,h,c as _,w as b,y as w,F as g,z as k,f as C,j as x,t as F,u as P,J as T,G as L,a1 as z,H as D,a2 as S,a3 as I}from"./index-4xE3Jiky.js";import{e as E,D as U,g as N,n as K,_ as A,B as M,m as j,b as G,a as O,h as $,K as R,Q as H,F as q,R as B,S as J}from"./useChildren.ogl1P_NW.js";import{f as Q,u as V}from"./request.BbQ2wDkA.js";import{w as X}from"./wd-toast.CSdeP_zF.js";const Y={PENDING:"pending",LOADING:"loading",SUCCESS:"success",FAIL:"fail"};function Z(){let t=null;const l=e=>{e?e.abort():t&&(t.abort(),t=null)};function i(e){return U(e.tempFiles)?e.tempFiles.map((e=>({path:e.path||"",name:e.name||"",size:e.size,type:"image",thumb:e.path||""}))):[{path:e.tempFiles.path||"",name:e.tempFiles.name||"",size:e.tempFiles.size,type:"image",thumb:e.tempFiles.path||""}]}return{startUpload:(e,s)=>{const{uploadMethod:a,formData:i={},action:r,name:n="file",header:u={},fileType:c="image",statusCode:d=200,statusKey:p="status",abortPrevious:m=!1}=s;e[p]=Y.LOADING;const f={action:r,header:u,name:n,fileName:n,fileType:c,statusCode:d,abortPrevious:m,onSuccess:(e,a,o)=>{var l;a[p]=Y.SUCCESS,t=null,null==(l=s.onSuccess)||l.call(s,e,a,o)},onError:(e,a,o)=>{var l;a[p]=Y.FAIL,a.error=e.errMsg,t=null,null==(l=s.onError)||l.call(s,e,a,o)},onProgress:(e,a)=>{var o;a.percent=e.progress,null==(o=s.onProgress)||o.call(s,e,a)}};return E(a)?a(e,i,f):((e,s,a)=>{a.abortPrevious&&l();const i=o({url:a.action,header:a.header,name:a.name,fileName:a.name,fileType:a.fileType,formData:s,filePath:e.url,success(o){o.statusCode===a.statusCode?a.onSuccess(o,e,s):a.onError({...o,errMsg:o.errMsg||""},e,s)},fail(o){a.onError(o,e,s)}});return t=i,i.onProgressUpdate((s=>{a.onProgress(s,e)})),i})(e,i,f)},abort:l,UPLOAD_STATUS:Y,chooseFile:function({multiple:o,sizeType:t,sourceType:l,maxCount:r,accept:n,compressed:u,maxDuration:c,camera:d,extension:p}){return new Promise(((m,f)=>{switch(n){case"image":default:e({count:o?r:1,sizeType:t,sourceType:l,extension:p,success:e=>m(i(e)),fail:f});break;case"video":a({sourceType:l,compressed:u,maxDuration:c,camera:d,extension:p,success:e=>m(function(e){return[{path:e.tempFilePath||e.filePath||"",name:e.name||"",size:e.size,type:"video",thumb:e.thumbTempFilePath||"",duration:e.duration}]}(e)),fail:f});break;case"all":s({count:o?r:1,type:n,extension:p,success:e=>m(e.tempFiles),fail:f})}}))}}}const W=A(t({name:"wd-video-preview",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:{...N},setup(e,{expose:s}){const a=l(!1),o=i({url:"",poster:"",title:""});function t(){a.value=!1,v((()=>{o.url="",o.poster="",o.title=""}))}return Q((()=>a.value)),s({open:function(e){a.value=!0,o.url=e.url,o.poster=e.poster,o.title=e.title},close:t}),(e,s)=>{const l=y,i=h;return a.value?(r(),n(i,{key:0,class:m(`wd-video-preview ${e.customClass}`),style:f(e.customStyle),onClick:t},{default:u((()=>[c(i,{class:"wd-video-preview__video",onClick:s[0]||(s[0]=p((()=>{}),["stop"]))},{default:u((()=>[o.url?(r(),n(l,{key:0,class:"wd-video-preview__video",controls:!0,poster:o.poster,title:o.title,"play-btn-position":"center",enableNative:!0,src:o.url,"enable-progress-gesture":!1},null,8,["poster","title","src"])):d("",!0)])),_:1}),c(K,{name:"close","custom-class":"wd-video-preview__close",onClick:t})])),_:1},8,["class","style"])):d("",!0)}}}),[["__scopeId","data-v-c338e1f7"]]),ee=A(t({name:"wd-upload",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:{...N,fileList:M(),action:j(""),header:{type:Object,default:()=>({})},multiple:G(!1),disabled:G(!1),limit:Number,showLimitNum:G(!0),maxSize:O(Number.MAX_VALUE),sourceType:{type:Array,default:()=>["album","camera"]},sizeType:{type:Array,default:()=>["original","compressed"]},name:j("file"),formData:{type:Object,default:()=>({})},onPreviewFail:Function,beforeUpload:Function,beforeChoose:Function,beforeRemove:Function,beforePreview:Function,buildFormData:Function,loadingType:j("ring"),loadingColor:j("#ffffff"),accept:j("image"),statusKey:j("status"),loadingSize:j("24px"),compressed:G(!0),maxDuration:O(60),camera:j("back"),imageMode:j("aspectFit"),successStatus:O(200),customEvokeClass:j(""),customPreviewClass:j(""),autoUpload:G(!0),reupload:G(!1),uploadMethod:Function,extension:Array},emits:["fail","change","success","progress","oversize","chooseerror","remove","update:fileList"],setup(e,{expose:s,emit:a}){const o=e,t=a;s({submit:()=>O(),abort:()=>A()});const{translate:i}=V("upload"),p=l([]),v=_((()=>!o.limit||p.value.length<o.limit)),U=l(),{startUpload:N,abort:A,chooseFile:M,UPLOAD_STATUS:j}=Z();function G(){t("update:fileList",p.value)}function O(){const{buildFormData:e,formData:s={},statusKey:a}=o,{action:t,name:l,header:i={},accept:r,successStatus:n,uploadMethod:u}=o,c=$(n)?n:200;for(const o of p.value)o[a]===j.PENDING&&(e?e({file:o,formData:s,resolve:e=>{e&&N(o,{action:t,header:i,name:l,formData:e,fileType:r,statusCode:c,statusKey:a,uploadMethod:u,onSuccess:se,onError:ee,onProgress:ae})}}):N(o,{action:t,header:i,name:l,formData:s,fileType:r,statusCode:c,statusKey:a,uploadMethod:u,onSuccess:se,onError:ee,onProgress:ae}))}function Q(e){return new Promise(((s,a)=>{I({src:e,success:e=>{s(e)},fail:e=>{a(e)}})}))}function Y(e,s){const{statusKey:a}=o,t={uid:H.id++,name:e.name||"",thumb:e.thumb||"",[a]:"pending",size:e.size||0,url:e.path,percent:0};"number"==typeof s?p.value.splice(s,1,t):p.value.push(t),o.autoUpload&&O()}function ee(e,s,a){const{statusKey:l}=o,i=p.value.findIndex((e=>e.uid===s.uid));i>-1&&(p.value[i][l]="fail",p.value[i].error=e.message,p.value[i].response=e,t("fail",{error:e,file:s,formData:a}),G())}function se(e,s,a){const{statusKey:l}=o,i=p.value.findIndex((e=>e.uid===s.uid));i>-1&&(p.value[i][l]="success",p.value[i].response=e.data,t("change",{fileList:p.value}),t("success",{file:s,fileList:p.value,formData:a}),G())}function ae(e,s){const a=p.value.findIndex((e=>e.uid===s.uid));a>-1&&(p.value[a].percent=e.progress,t("progress",{response:e,file:s}))}function oe(e){const{multiple:s,maxSize:a,accept:l,sizeType:i,limit:r,sourceType:n,compressed:u,maxDuration:c,camera:d,beforeUpload:m,extension:f}=o;M({multiple:!$(e)&&s,sizeType:i,sourceType:n,maxCount:r?r-p.value.length:r,accept:l,compressed:u,maxDuration:c,camera:d,extension:f}).then((o=>{let l=o;s||(l=l.slice(0,1));const i=async s=>{for(let o=0;o<s.length;o++){const l=s[o];if("image"===l.type&&!l.size){const e=await Q(l.path);l.size=e.width*e.height}Number(l.size)<=a?Y(l,e):t("oversize",{file:l})}};m?m({files:l,fileList:p.value,resolve:e=>{e&&i(l)}}):i(l)})).catch((e=>{t("chooseerror",{error:e})}))}function te(e){if(o.disabled)return;const{beforeChoose:s}=o;s?s({fileList:p.value,resolve:s=>{s&&oe(e)}}):oe(e)}function le(e){p.value.splice(p.value.findIndex((s=>s.uid===e.uid)),1),t("change",{fileList:p.value}),t("remove",{file:e}),G()}function ie(e){z({filePath:e.url,showMenu:!0})}function re(e,s){const{onPreviewFail:a}=o;D({urls:s,current:s[e],fail(){a?a({index:e,imgList:s}):S({title:"预览图片失败",icon:"none"})}})}function ne(e,s){var a;null==(a=U.value)||a.open({url:s[e].url,poster:s[e].thumb,title:s[e].name})}function ue(e){const{beforePreview:s,reupload:a}=o,t=q(p.value),l=t.findIndex((s=>s.url===e.url)),i=t.filter((e=>ce(e))),r=i.findIndex((s=>s.url===e.url));a?te(l):s?s({file:e,index:l,imgList:[],fileList:t,resolve:e=>{e&&ne(r,i)}}):ne(r,i)}function ce(e){return e.name&&B(e.name)||B(e.url)}function de(e){return e.name&&J(e.name)||J(e.url)}return b((()=>o.fileList),(e=>{const{statusKey:s}=o;if(R(e,p.value))return;const a=e.map((e=>(e[s]=e[s]||"success",e.response=e.response||"",{...e,uid:H.id++})));p.value=a}),{deep:!0,immediate:!0}),b((()=>o.limit),(e=>{e&&e<p.value.length&&console.error("[wot-design]Error: props limit must less than fileList.length")}),{deep:!0,immediate:!0}),b((()=>o.beforePreview),(e=>{e&&!E(e)&&console.error("The type of beforePreview must be Function")}),{deep:!0,immediate:!0}),b((()=>o.onPreviewFail),(e=>{e&&!E(e)&&console.error("The type of onPreviewFail must be Function")}),{deep:!0,immediate:!0}),b((()=>o.beforeRemove),(e=>{e&&!E(e)&&console.error("The type of beforeRemove must be Function")}),{deep:!0,immediate:!0}),b((()=>o.beforeUpload),(e=>{e&&!E(e)&&console.error("The type of beforeUpload must be Function")}),{deep:!0,immediate:!0}),b((()=>o.beforeChoose),(e=>{e&&!E(e)&&console.error("The type of beforeChoose must be Function")}),{deep:!0,immediate:!0}),b((()=>o.buildFormData),(e=>{e&&!E(e)&&console.error("The type of buildFormData must be Function")}),{deep:!0,immediate:!0}),(e,s)=>{const a=T,t=h,l=y,_=L;return r(),w(g,null,[c(t,{class:m(["wd-upload",e.customClass]),style:f(e.customStyle)},{default:u((()=>[(r(!0),w(g,null,k(p.value,((s,f)=>(r(),n(t,{class:m(["wd-upload__preview",e.customPreviewClass]),key:f},{default:u((()=>[c(t,{class:"wd-upload__status-content"},{default:u((()=>[de(s)?(r(),n(a,{key:0,src:s.url,mode:e.imageMode,class:"wd-upload__picture",onClick:e=>function(e){const{beforePreview:s,reupload:a}=o,t=q(p.value),l=t.findIndex((s=>s.url===e.url)),i=t.filter((e=>de(e))).map((e=>e.url)),r=i.findIndex((s=>s===e.url));a?te(l):s?s({file:e,index:l,fileList:t,imgList:i,resolve:e=>{e&&re(r,i)}}):re(r,i)}(s)},null,8,["src","mode","onClick"])):ce(s)?(r(),w(g,{key:1},[s.thumb?(r(),n(t,{key:0,class:"wd-upload__video",onClick:e=>ue(s)},{default:u((()=>[c(a,{src:s.thumb,mode:e.imageMode,class:"wd-upload__picture"},null,8,["src","mode"]),c(K,{name:"play-circle-filled","custom-class":"wd-upload__video-paly"})])),_:2},1032,["onClick"])):(r(),n(t,{key:1,class:"wd-upload__video",onClick:e=>ue(s)},{default:u((()=>[c(l,{src:s.url,title:s.name||"视频"+f,"object-fit":"contain",controls:!1,poster:s.thumb,autoplay:!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"show-play-btn":!1,"show-loading":!1,"show-progress":!1,"show-mute-btn":!1,"enable-progress-gesture":!1,enableNative:!0,class:"wd-upload__video"},null,8,["src","title","poster"]),c(K,{name:"play-circle-filled","custom-class":"wd-upload__video-paly"})])),_:2},1032,["onClick"]))],64)):(r(),n(t,{key:2,class:"wd-upload__file",onClick:e=>function(e){const{beforePreview:s,reupload:a}=o,t=q(p.value),l=t.findIndex((s=>s.url===e.url));a?te(l):s?s({file:e,index:l,imgList:[],fileList:t,resolve:s=>{s&&ie(e)}}):ie(e)}(s)},{default:u((()=>[c(K,{name:"file","custom-class":"wd-upload__file-icon"}),c(t,{class:"wd-upload__file-name"},{default:u((()=>[x(F(s.name||s.url),1)])),_:2},1024)])),_:2},1032,["onClick"]))])),_:2},1024),"success"!==s[o.statusKey]?(r(),n(t,{key:0,class:"wd-upload__mask wd-upload__status-content"},{default:u((()=>["loading"===s[o.statusKey]?(r(),n(t,{key:0,class:"wd-upload__status-content"},{default:u((()=>[c(X,{type:e.loadingType,size:e.loadingSize,color:e.loadingColor},null,8,["type","size","color"]),c(_,{class:"wd-upload__progress-txt"},{default:u((()=>[x(F(s.percent)+"%",1)])),_:2},1024)])),_:2},1024)):d("",!0),"fail"===s[o.statusKey]?(r(),n(t,{key:1,class:"wd-upload__status-content"},{default:u((()=>[c(K,{name:"close-outline","custom-class":"wd-upload__icon"}),c(_,{class:"wd-upload__progress-txt"},{default:u((()=>[x(F(s.error||P(i)("error")),1)])),_:2},1024)])),_:2},1024)):d("",!0)])),_:2},1024)):d("",!0),"loading"===s[o.statusKey]||e.disabled?d("",!0):(r(),n(K,{key:1,name:"error-fill","custom-class":"wd-upload__close",onClick:e=>function(e){const{beforeRemove:s}=o,a=e,t=p.value[a];s?s({file:t,index:a,fileList:p.value,resolve:e=>{e&&le(t)}}):le(t)}(f)},null,8,["onClick"])),e.$slots["preview-cover"]?C(e.$slots,"preview-cover",{key:2,file:s,index:f},void 0,!0):d("",!0)])),_:2},1032,["class"])))),128)),v.value?(r(),w(g,{key:0},[e.$slots.default?(r(),n(t,{key:0,class:m(["wd-upload__evoke-slot",e.customEvokeClass]),onClick:te},{default:u((()=>[C(e.$slots,"default",{},void 0,!0)])),_:3},8,["class"])):(r(),n(t,{key:1,onClick:te,class:m(["wd-upload__evoke",e.disabled?"is-disabled":"",e.customEvokeClass])},{default:u((()=>[c(K,{class:"wd-upload__evoke-icon",name:"fill-camera"}),e.limit&&e.showLimitNum?(r(),n(t,{key:0,class:"wd-upload__evoke-num"},{default:u((()=>[x("（"+F(p.value.length)+"/"+F(e.limit)+"）",1)])),_:1})):d("",!0)])),_:1},8,["class"]))],64)):d("",!0)])),_:3},8,["class","style"]),c(W,{ref_key:"videoPreview",ref:U},null,512)],64)}}}),[["__scopeId","data-v-5b6e2601"]]);export{ee as _};
